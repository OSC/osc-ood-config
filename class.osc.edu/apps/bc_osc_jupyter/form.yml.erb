<%- 

  raw_groups = OodSupport::User.new.groups

  groups = raw_groups.sort_by(&:id).tap { |groups|
    groups.unshift(groups.delete(OodSupport::Process.group))
  }.map(&:name).grep(/^P./)

  staff = raw_groups.map(&:name).include?('oscall')

  base_modules = "project/classroom"

  group_lookup = {
    "BIOCHEM 5721"     => "PAS1745",
    "PHYSICS 6820"     => "PAS1759",
    "OSC JUPYTER"      => "oscall", #not really required, but kept to avoid confusion
    "PHYSICS 280 WIT"  => "PWIT0412",
    "PHYSICS 4032 OU"  => "PHS0346",
    "PHYSICS 5071 OU"  => "PHS0353",
    "MATH 2530 OU"     => "PHS0352",
    "GRADTDA 5622"     => "PAS1871",
    "CSE 5194.01"      => "PAS1911",
    "EEOB 889619"      => "PAS1918",
    "GRADTDA 5620"     => "PAS1979",
    "MIME 4980"        => "PJS0333",
    "2021 CCC BISR - CRISPR Screen Data Analysis Workshop" => "PAS1984",
  }.select { |k,v| groups.include?(v) }

  classes = {
    "BIOCHEM 5721"     => "#{base_modules} jupyter/BIOCHEM5721",
    "PHYSICS 6820"     => "#{base_modules} jupyter/PHYSICS6820",
    "OSC Jupyter"      => "#{base_modules} jupyter/OSCJUPYTER",
    "PHYSICS 280 WIT"  => "#{base_modules} jupyter/PHYS280_WIT",
    "PHYSICS 4032 OU"  => "#{base_modules} jupyter/PHYS4032_OU",
    "PHYSICS 5071 OU"  => "#{base_modules} jupyter/PHYS5071_OU",
    "MATH 2530 OU"     => "#{base_modules} jupyter/MATH2530_OU",
    "GRADTDA 5622"     => "#{base_modules} jupyter/GRADTDA5622",
    "CSE 5194.01"      => "#{base_modules} jupyter/CSE519401",
    "EEOB 889619"      => "#{base_modules} jupyter/EEOB889619",
    "GRADTDA 5620"     => "#{base_modules} jupyter/GRADTDA5620",
    "MIME 4980"        => "#{base_modules} jupyter/MIME4980",
    "2021 CCC BISR - CRISPR Screen Data Analysis Workshop" => "#{base_modules} jupyter/2021CCCBISR",
  }.select { |k,v| group_lookup.has_key?(k) || staff }

  classes_w_lab_default = [
    'PAS1871',
  ]

-%>
---
cluster: "owens"
form:
  - version
  - jupyterlab_switch
  - bc_num_hours
  - account
  - node_type
  - num_cores
  - staff
  - classroom
attributes:
  node_type: "any"
  classroom: 1
  jupyterlab_switch:
    widget: "check_box"
    label: "Use JupyterLab instead of Jupyter Notebook?"
    value: "<%= groups.intersection(classes_w_lab_default).empty? ? "0" : "1" %>"
  num_cores:
    widget: "number_field"
    label: "Number of cores"
    value: 1
    min: 0
    max: 28
    step: 1
  account:
    widget: select
    options:
    <%- for group in groups -%>
      - "<%= group %>"
    <%- end %>
  <%- if classes.empty? -%>
  version: "app_jupyter/2.1.4"
  <%- else -%>
  version:
    widget: "select"
    label: "Class Materials"
    options:
    <%- classes.each do |class_name, class_modules| -%>
      - [ "<%= class_name %>", "<%= class_modules %>" ]
    <%- end -%>
    required: true
    html_options:
      data-custom: 
        "with spaces": "value"
  <%- end -%>
  staff:
    widget: "check_box"
    checked_value: <%= staff ? "1" : "0" %>
submit: submit.yml.erb
